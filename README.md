# Python for SQL. Part_01

–û–¥–∏–Ω –∏–∑ –∫–µ–π—Å–æ–≤ –ø–æ –ø–∏—Ç–æ–Ω—É

[–î–º–∏—Ç—Ä–∏–π –ö—É–∑—å–º–∏–Ω. –ò–Ω–∂–µ–Ω–µ—Ä–∏—è –¥–∞–Ω–Ω—ã—Ö](https://t.me/kuzmin_dmitry91/29)

–ù–µ —Ç–∞–∫ –¥–∞–≤–Ω–æ –≤ —Å–≤–æ–µ–π —Ä–∞–±–æ—Ç–µ —è —Å—Ç–æ–ª–∫–Ω—É–ª—Å—è —Å –ø—Ä–æ–±–ª–µ–º–æ–π –Ω–∞–ø–∏—Å–∞–Ω–∏—è –æ–≥—Ä–æ–º–Ω–æ–π –ø–æ—Ä—Ç—è–Ω–∫–∏ –∫–æ–¥–∞ –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –∞–≥—Ä–µ–≥–∞—Ç–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –ø–æ–ª–µ–π —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –∏—Ö –æ—Å–Ω–æ–≤–µ.

## –ò—Å—Ö–æ–¥–Ω–∏–∫

–¢–∞–±–ª–∏—Ü–∞ –≤ –ø–∞—Ä–∫–µ—Ç–µ –Ω–∞ hdfs, –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —ç—Ç–æ id, –¥–∞—Ç–∞ –∏ –æ–∫–æ–ª–æ 120 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ –ø–æ —ç—Ç–∏–º id.

–¢–æ –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ —Å 122 —Å—Ç–æ–ª–±—Ü–∞–º–∏.

### **–ó–∞–¥–∞—á–∞**

**–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ id –ø–æ—Å—á–∏—Ç–∞—Ç—å –∞–≥—Ä–µ–≥–∞—Ç—ã, –∏ —Å–¥–µ–ª–∞—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è —Å —ç—Ç–∏–º–∏ –∞–≥—Ä–µ–≥–∞—Ç–∞–º–∏ –ø–æ –∫–∞–∂–¥–æ–º—É id.**

–°–ø–∏—Å–æ–∫ –∞–≥—Ä–µ–≥–∞—Ç–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π, –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ—Ç–æ—Ä—ã—Ö –±—É–¥—É—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –Ω–æ–≤—ã–µ –ø–æ–ª—è:

- min
- max
- avg
- std
- percentile_10
- percentile_50
- percentile_90

> –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –µ—Å–ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –≤—Å–µ –ø–æ–ª—è –≤—Ä—É—á–Ω—É—é, —Ç–æ –∫–æ–ª–ª–µ–≥–∏ –ø–æ–∫—Ä—É—Ç—è—Ç –ø–∞–ª—å—Ü–µ–º —É –≤–∏—Å–∫–∞. –î–∞ –∏ –≤—Ä–µ–º–µ–Ω–∏ —ç—Ç–æ –∑–∞–π–º–µ—Ç –Ω–µ–º–∞–ª–æ. –ù–æ —Å–∞–º–æ–µ –≥—Ä—É—Å—Ç–Ω–æ–µ –≤ —ç—Ç–æ–π –∏—Å—Ç–æ—Ä–∏–∏ - –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –æ—Ç–ª–æ–≤–∏—Ç—å –±–∞–≥ –∏–ª–∏ –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å —á—Ç–æ-–ª–∏–±–æ –ø–æ –ø—Ä–æ—Å—å–±–µ –∑–∞–∫–∞–∑—á–∏–∫–∞.
> 

–ò–¥–µ—è¬†–≤ —Ç–æ–º, —á—Ç–æ–±—ã –Ω–∞–ø–∏—Å–∞—Ç—å –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å

120 * 7 = 840 –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π.

–Ø –±—ã–ª —É–¥–∏–≤–ª–µ–Ω (—Ö–æ—Ç—è –∏ –¥–æ–ø—É—Å–∫–∞–ª), —á—Ç–æ –º–æ–∂–Ω–æ –æ—Ç–¥–µ–ª—å–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π, –∞ –∑–∞—Ç–µ–º –ø–µ—Ä–µ–¥–∞—Ç—å –µ–≥–æ –≤ SQL –∑–∞–ø—Ä–æ—Å.

## –†–µ—à–µ–Ω–∏–µ

1. –î–ª—è –Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª–µ–π, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –Ω—É–∂–Ω–æ –ø–æ—Å—á–∏—Ç–∞—Ç—å –∞–≥—Ä–µ–≥–∞—Ç—ã –ø–æ –∑–∞–¥–∞—á–µ:

```python
cols = ['colunm_1',
        'colunm_2',
        'colunm_3',
        'colunm_4',
        'colunm_5',
        ...
        'colunm_120']
```

–ó–∞—Ç–µ–º —Å–æ–∑–¥–∞–¥–∏–º —Å–ª–æ–≤–∞—Ä—å —Å –Ω—É–∂–Ω—ã–º–∏ –ø–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º—É –∑–∞–¥–∞–Ω–∏—é —Ñ—É–Ω–∫—Ü–∏—è–º–∏:

```python
funcs = { "min": "min('{col}')",
         "max": "max('{col}')",
         "avg": "avg('{col}')",
         "std": "std('{col}')",
         "percentile_10": "percentile('{col}', 0.1)",
         "percentile_50": "percentile('{col}', 0.5)",
         "percentile_90": "percentile('{col}', 0.9)" }
```

–°–æ–∑–¥–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —á–µ—Ä–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ø–∏—Å–∫–∞ –∏ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –µ–≥–æ –∫ —Å—Ç—Ä–æ–∫–µ –ø–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–µ –ø–æ–ª—è —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é:

```python
col_list = ",".join([func.format(col=col)+f" as {func_prefix}_{col}"for colin colsfor func_prefix, funcin funcs.items()]).replace("'","")
```

–ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ spark.sql:

```sql
(
  spark.sql(f"""
    select
      id,
      date,
      {col_list}
    from table
    group by id, date
    """.format(col_list=col_list))
.repartition('date')
.write
.partitionBy('date')
.mode("overwrite")
.parquet("new_table") )
```

---

## Hardmode

![IMG_6122.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/4f7c3174-5a9b-4b45-b7b7-59ecea8d9de0/f8725ba5-b4a1-457a-9012-b4627989e852/IMG_6122.jpeg)

–ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, –≤—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ, –æ–¥–Ω–∞–∫–æ –∑–∞–∫–∞–∑—á–∏–∫ –∏–∑–º–µ–Ω–∏–ª —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –∏ —Ç–∞–∫–∂–µ —Ö–æ—á–µ—Ç, —á—Ç–æ–±—ã –ø–æ –∞—Ç—Ä–∏–±—É—Ç—É ¬´—Å—Ç–∞—Ç—É—Å¬ª –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è. 

–ë–æ–ª–µ–µ —Ç–æ–≥–æ, –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —ç—Ç–æ–≥–æ –ø–æ–ª—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ—Å—á–∏—Ç–∞—Ç—å –≤—Å–µ —Å–µ–º—å –∞—Ç—Ä–∏–±—É—Ç–æ–≤. –£ –æ–¥–Ω–æ–≥–æ id –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å–æ–≤.

**–ö–∞–∫–∏–µ —Å—Ç–∞—Ç—É—Å—ã –º–æ–≥—É—Ç –±—ã—Ç—å?** 

–î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –¥–∞–≤–∞–π—Ç–µ –ø—Ä–∏–º–µ–º:

- –í—Å–µ —Å–ª—É—á–∞–∏ (1=1)
- –ü—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ ('vip')
- –û–±—ã—á–Ω—ã–µ ('common')
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ ('uniq')
- –ê–∫—Ç–∏–≤–Ω—ã–π ('active')
- –ù–µ –∞–∫—Ç–∏–≤–Ω—ã–π ('inactive')

**–†–∞—Å—Å–º–æ—Ç—Ä–∏–º –∫—Ä–∞–π–Ω–∏–µ —Å–ª—É—á–∞–∏:**

–ï—Å–ª–∏ —É –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–µ—Ç –Ω–∏–∫–∞–∫–∏—Ö —Å—Ç–∞—Ç—É—Å–æ–≤, —Ç–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ (1=1), –∏ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–æ–≥–æ–≤—ã—Ö –ø–æ–ª–µ–π —Å–æ—Å—Ç–∞–≤–∏—Ç: 120¬†*¬†7¬†*¬†1 = 840.

–û–¥–Ω–∞–∫–æ, –µ—Å–ª–∏ —É –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ —Ä–∞–±–æ—Ç–µ –∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º, —Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–æ–≥–æ–≤—ã—Ö –ø–æ–ª–µ–π –±—É–¥–µ—Ç –±–æ–ª—å—à–µ: 120 * 7 * 3 = 2520.

–ù–æ —á—Ç–æ, –µ—Å–ª–∏ —É –∫–ª–∏–µ–Ω—Ç–æ–≤ –±–æ–ª—å—à–µ —Ñ—É–Ω–∫—Ü–∏–π –∏–ª–∏ —Å—Ç–∞—Ç—É—Å–æ–≤? –í —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–æ–≥–æ–≤—ã—Ö –ø–æ–ª–µ–π –±—É–¥–µ—Ç –µ—â–µ –≤—ã—à–µ.

**–ù–∞–ø–∏—à–µ–º –∫–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–∫–∏—Ö –ø–æ–ª–µ–π:**

–ö–∞–∫ –∏ –≤ –ø–µ—Ä–≤–æ–º –≤–∞—Ä–∏–∞–Ω—Ç–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª–µ–π, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –Ω—É–∂–Ω–æ –ø–æ—Å—á–∏—Ç–∞—Ç—å –∞–≥—Ä–µ–≥–∞—Ç—ã –ø–æ –∑–∞–¥–∞—á–µ:

```python
cols = ['colunm_1',
        'colunm_2',
        'colunm_3',
        'colunm_4',
        'colunm_5',
        ...
        'colunm_120']
```

–°–æ–∑–¥–∞–µ–º —Å–ª–æ–≤–∞—Ä—å —Å—Ç–∞—Ç—É—Å–æ–≤. –ì–¥–µ-—Ç–æ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —É –Ω–∞—Å –µ—Å—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –Ω–æ–º–µ—Ä–æ–≤ —Å—Ç–∞—Ç—É—Å–æ–≤ –∏ –∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π.

```python
types = { 'all':'1=1',
         'vip':'status=34',
         'common':'status=35',
         'uniq':'status=60',
         'active':'status=70',
         'inactive':'status=71', }
case = 'case when {type} then {col} end'
```

*–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è case –≤—ã—à–µ –Ω—É–∂–Ω–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ª–æ–≤–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ —É –∫–∞–∂–¥–æ–≥–æ id.*

–°–æ–∑–¥–∞–µ–º —Å–ª–æ–≤–∞—Ä—å —Å –Ω—É–∂–Ω—ã–º–∏ –ø–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º—É –∑–∞–¥–∞–Ω–∏—é —Ñ—É–Ω–∫—Ü–∏—è–º–∏:

```python
funcs = { "min": "min('{col}')",
"max": "max('{col}')",
"avg": "avg('{col}')",
"std": "std('{col}')",
"percentile_10": "percentile('{col}', 0.1)",
"percentile_50": "percentile('{col}', 0.5)",
"percentile_90": "percentile('{col}', 0.9)" }
```

–°–æ–∑–¥–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —á–µ—Ä–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ø–∏—Å–∫–∞ –∏ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –µ–≥–æ –∫ —Å—Ç—Ä–æ–∫–µ –ø–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–µ –ø–æ–ª—è —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é:

```python
col_list = ",".join([func.format(col=col, type=type)+f" as {func_prefix}{col}{type_suf}" for col in cols for type_suf, type in types.items() for func_prefix, func in funcs.items()]).replace("'","")
```

–ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ spark.sql

```sql
(
spark.sql(f"""
select
id,
date,
{col_list}
from table
group by id, date
""".format(col_list=col_list))
.repartition('date')
.write
.partitionBy('date')
.mode("overwrite")
.parquet("new_table") )
```

### **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ**

–ò—Ç–æ–≥ - –∑–∞ 4-5 –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞ –º—ã –ø–æ–ª—É—á–∏–ª–∏ –∏–∑ 120 –ø–æ–ª–µ–π —Ç–∞–±–ª–∏—Ü—É –≤ 2500 –ø–æ–ª–µ–π. –£–¥–æ–±–Ω–æ? –í—Ä–æ–¥–µ –¥–∞ üôÇ‚Äç‚ÜïÔ∏è 

–î—Ä—É–∑—å—è, –∫—Ç–æ —Å–æ–º–Ω–µ–≤–∞–µ—Ç—Å—è, —á—Ç–æ —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –Ω—É–∂–µ–Ω - –Ω–µ —Å–æ–º–Ω–µ–≤–∞–π—Ç–µ—Å—å, –æ–Ω –Ω—É–∂–µ–Ω.

–¢–æ—á–Ω–µ–µ –æ–Ω —Å–∏–ª—å–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á.

*–û—á–µ–Ω—å –Ω–∞–¥–µ—é—Å—å, —á—Ç–æ —ç—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–∫–∞–∂–µ—Ç—Å—è –¥–ª—è –≤–∞—Å –ø–æ–ª–µ–∑–Ω–æ–π.*
