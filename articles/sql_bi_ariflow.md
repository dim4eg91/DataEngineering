![sql_bi_airflow](images/main_tools_for_building_bi.png)

## **–ö–∞–∫ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –æ—Ç—á–µ—Ç —Å –æ–±–Ω–æ–≤–ª—è–µ–º—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –≤ Qlik Sense, –∏—Å–ø–æ–ª—å–∑—É—è SQL –∏ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä—ã?**

–•–æ—á—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –∫–µ–π—Å –¥–ª—è –¥–∞—Ç–∞-–∏–Ω–∂–µ–Ω–µ—Ä–æ–≤ –∏ BI-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤: –∫–∞–∫ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—á–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –¥–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Ö —Ä—É—á–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å **–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º—ã–π –æ—Ç—á–µ—Ç –≤ Qlik Sense**. –ó–¥–µ—Å—å –Ω–∞ —Å—Ç—ã–∫–µ —Å—Ö–æ–¥—è—Ç—Å—è **SQL**, –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä—ã –∑–∞–¥–∞—á (–Ω–∞–ø—Ä–∏–º–µ—Ä, Airflow) –∏ BI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.

---

### **üìã –°—É—Ç—å –∑–∞–¥–∞—á–∏**  

1. **–°—Ç–∞—Ç—É—Å—ã –∏ —Ä–∞—Å—á–µ—Ç—ã**:  
   –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Ä–∞—Å—á–µ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É **Greenplum** (`table_main`).  
2. **–†—É—á–Ω–æ–µ –æ–±–æ–≥–∞—â–µ–Ω–∏–µ**:  
   –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å **–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏** –∏ **—Ñ–ª–∞–≥–∏** –≤—Ä—É—á–Ω—É—é.  
3. **–ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**:  
   –î–ª—è Qlik Sense —Å–æ–∑–¥–∞–µ—Ç—Å—è **VIEW**, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç **—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏** –¥–∞–Ω–Ω—ã—Ö (–ø–æ –¥–∞—Ç–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —Å—Ç–∞—Ç—É—Å—É).  

**–ù–∞ –≤—ã—Ö–æ–¥–µ**: Qlik Sense —Å—Ç—Ä–æ–∏—Ç –æ—Ç—á–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ.

---

### **üîß –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã**

üìÉ –ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–ª—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –æ–±–æ–≥–∞—â–µ–Ω–∏—è:

```sql
-- –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
CREATE TABLE table_main (
  dt DATE,                          -- –î–∞—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞
  id INT,                           -- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏
  status TEXT,                      -- –°—Ç–∞—Ç—É—Å –∑–∞–ø–∏—Å–∏
  sys_value FLOAT,                  -- –°–∏—Å—Ç–µ–º–Ω–æ–µ —Ä–∞—Å—á–µ—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
  sys_color TEXT,                   -- –°–∏—Å—Ç–µ–º–Ω—ã–π —Ü–≤–µ—Ç
  user_comments TEXT DEFAULT NULL,  -- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  user_color TEXT DEFAULT NULL,     -- –¶–≤–µ—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  load_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP  -- –î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
);
```

**–ß—Ç–æ –∑–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?**
- –ü–æ–ª—è `sys_value` –∏ `sys_color` ‚Äî —ç—Ç–æ —Ä–∞—Å—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.  
- –ü–æ–ª—è `user_comments` –∏ `user_color` –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è —Ä—É—á–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.  
- –ü–æ–ª–µ `load_date` –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.

---

### **‚öôÔ∏è –®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü—É**

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞—Å—á–µ—Ç–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (`insert_view`). –≠—Ç–æ—Ç –ø—Ä–æ—Ü–µ—Å—Å –º–æ–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å –ø–æ–º–æ—â—å—é SQL-—Å–∫—Ä–∏–ø—Ç–∞:

```sql
-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è insert_view
INSERT INTO table_main 
SELECT 
  dt, 
  id, 
  status, 
  sys_value, 
  sys_color,
  NULL AS user_comments,   -- –ü–æ–ª–µ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
  NULL AS user_color,      -- –ü–æ–ª–µ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
  NOW() AS load_date       -- –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏
FROM insert_view;
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —ç—Ç–æ–º –∑–∞–ø—Ä–æ—Å–µ?**
- –î–∞–Ω–Ω—ã–µ –∏–∑ `insert_view` –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `table_main`.  
- –ü–æ–ª—è `user_comments` –∏ `user_color` –æ—Å—Ç–∞—é—Ç—Å—è –ø—É—Å—Ç—ã–º–∏, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥–ª–∏ –≤–Ω–æ—Å–∏—Ç—å —Ä—É—á–Ω—ã–µ –ø—Ä–∞–≤–∫–∏.  
- –ü–æ–ª–µ `load_date` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å—Ç–∞–≤–∫–∏.

**–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è:**
–ß—Ç–æ–±—ã —ç—Ç–æ—Ç SQL-–∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–ª—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
1. **Airflow**: –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—á.
2. **Cron**: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á –Ω–∞ Linux.

---

### **üñ•Ô∏è –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–ª—è Qlik Sense**

–¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–¥–∏–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ (`VIEW`), –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å **—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ** –ø–æ —Å—Ç–∞—Ç—É—Å—É –∏ –¥–∞—Ç–µ –∑–∞–≥—Ä—É–∑–∫–∏. –î–ª—è —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é `DENSE_RANK`:

```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ VIEW –¥–ª—è Qlik Sense —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
CREATE VIEW view_main AS 
WITH ranked_data AS (
  SELECT 
    *,
    DENSE_RANK() OVER (PARTITION BY status, dt ORDER BY load_date DESC) AS rn
  FROM table_main
)
SELECT 
  dt,
  id,
  status,
  sys_value,
  sys_color,
  user_comments,
  user_color,
  load_date
FROM ranked_data
WHERE rn = 1  -- –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏
ORDER BY dt DESC, id;
```

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?**
1. **`DENSE_RANK`**: –Ω—É–º–µ—Ä—É–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ —Ä–∞–º–∫–∞—Ö –≥—Ä—É–ø–ø—ã `status` –∏ `dt`, –Ω–∞—á–∏–Ω–∞—è —Å —Å–∞–º–æ–π –ø–æ—Å–ª–µ–¥–Ω–µ–π –¥–∞—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏.
2. **–§–∏–ª—å—Ç—Ä `WHERE rn = 1`**: –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏ —Å —Å–∞–º—ã–º —Å–≤–µ–∂–∏–º –≤—Ä–µ–º–µ–Ω–µ–º –∑–∞–≥—Ä—É–∑–∫–∏.
3. **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ `view_main` –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ Qlik Sense.

---

### **üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞: Airflow –∏–ª–∏ Cron**

–ß—Ç–æ–±—ã SQL-—Å–∫—Ä–∏–ø—Ç—ã –≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å –∫–∞–∂–¥—ã–π –¥–µ–Ω—å, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

#### **1. Airflow**
Airflow –ø–æ–∑–≤–æ–ª—è–µ—Ç –≥–∏–±–∫–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–¥–∞—á–∞–º–∏ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏:

```python
from airflow import DAG
from airflow.operators.postgres_operator import PostgresOperator
from datetime import datetime

# DAG –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
with DAG('daily_status_load', start_date=datetime(2024, 1, 1), schedule_interval='@daily') as dag:
    load_data = PostgresOperator(
        task_id='load_daily_data',
        postgres_conn_id='gp_connection',
        sql='sql/daily_insert.sql'  # SQL-—Ñ–∞–π–ª —Å INSERT INTO
    )
    load_data
```

#### **2. Cron**
–ï—Å–ª–∏ Airflow –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –ø–æ–¥–æ–π–¥–µ—Ç –ø—Ä–æ—Å—Ç–æ–π Cron –≤ Linux:

1. –°–æ–∑–¥–∞–π—Ç–µ SQL-—Ñ–∞–π–ª `daily_insert.sql` —Å –∫–æ–¥–æ–º –∑–∞–≥—Ä—É–∑–∫–∏.
2. –î–æ–±–∞–≤—å—Ç–µ –∑–∞–¥–∞—á—É –≤ `crontab`:

```bash
0 0 * * * psql -h host -U user -d database -f /path/to/daily_insert.sql
```

**`0 0 * * *`** ‚Äî –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤ –ø–æ–ª–Ω–æ—á—å –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.

---

### **üìä –ò—Ç–æ–≥–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**

1. **–†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç—É—Å–æ–≤** ‚Üí **–¢–∞–±–ª–∏—Ü–∞** `table_main`.  
2. **–†—É—á–Ω–æ–µ –æ–±–æ–≥–∞—â–µ–Ω–∏–µ** ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–ø–æ–ª–Ω—è—é—Ç –¥–∞–Ω–Ω—ã–µ (`user_comments`, `user_color`).  
3. **–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è** ‚Üí `view_main` –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ.  
4. **–û—Ç—á–µ—Ç –≤ Qlik Sense** ‚Üí –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ `view_main`.  

---

### **üîç –ü–æ—á–µ–º—É —ç—Ç–æ –ø–æ–ª–µ–∑–Ω–æ?**

–≠—Ç–æ—Ç –∫–µ–π—Å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ **SQL**, **–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä—ã** (Airflow/cron) –∏ **BI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã** —Ä–∞–±–æ—Ç–∞—é—Ç –≤–º–µ—Å—Ç–µ:

- SQL –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ª–æ–≥–∏–∫—É –∏ —Ä–∞—Å—á–µ—Ç—ã.  
- –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á.  
- BI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ—Ç **–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

---

### **‚ùì –ö–∞–∫ –±—ã –≤—ã —Ä–µ—à–∏–ª–∏ —ç—Ç—É –∑–∞–¥–∞—á—É?**  

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –±—ã Airflow –∏–ª–∏ –ø—Ä–µ–¥–ø–æ—á–ª–∏ –ø—Ä–æ—Å—Ç–æ–π cron?  
- –ö–∞–∫ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–ª–∏ –±—ã —Ä—É—á–Ω–æ–µ –æ–±–æ–≥–∞—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö?  

–î–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º –æ–ø—ã—Ç–æ–º –∏ –ø–æ–¥—Ö–æ–¥–∞–º–∏! üöÄ